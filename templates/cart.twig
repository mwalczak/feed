{% extends "layout.html" %}

{% block title %}Cart{% endblock %}
{% block content %}
    <h1>Cart page</h1>
    <h4>Total products: {{ cart|length }}</h4>
    <table class="cart" id="cart">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
        </tr>
        </thead>
        {% for product in cart %}
            <tr>
                <td>{{ product.id }}</td>
                <td>{{ product.title }}</td>
                <td class="product_price">{{ product.price }}</td>
                <td><input class="product_quantity" type="text" value="{{ product.quantity }}" maxlength="3"
                           data-product-id="{{ product.id }}"/></td>
                <td class="product_total">{{ product.total }}</td>
            </tr>
        {% endfor %}
        <tfoot>
        <tr>
            <th>Total</th>
            <th></th>
            <th></th>
            <th></th>
            <th id="cart_total">{{ total }}</th>
        </tr>
        </tfoot>
    </table>
    {% include 'include/cart_buttons.twig' %}
{% endblock %}

{% block script %}
    <script type="text/javascript">
        var inputs = document.getElementsByClassName("product_quantity");
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].addEventListener('change', function (e) {
                var quantity = e.srcElement.value;
                var productId = e.srcElement.dataset.productId;
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log("Product " + productId + " quantity changed: " + quantity);
                        calc_cart();
                    }
                };
                xhttp.open("POST", "/product/" + productId + "/quantity", true);
                xhttp.send(quantity);
            });
        }
    </script>
    {% include 'script/cart.twig' %}
{% endblock %}
